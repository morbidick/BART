<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

	<title>BarT</title>

	<script src="node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>

	<script>
		const serviceUuid = 0x181A;
		const absZero = 273.15;

		function dataViewToValues({ buffer }) {
			let connected = new DataView(buffer, 0, 1).getInt8() === 1;
			let temp0 = null;
			let temp1 = null;

			if (connected) {
				temp0 = new DataView(buffer, 1, 2).getInt16() / 10;
				temp1 = new DataView(buffer, 3, 2).getInt16() / 10;
			}

			return {connected, temp0, temp1};
		}

		async function demo() {
			try {
				console.log('Requesting Bluetooth Device...');
				const device = await navigator.bluetooth.requestDevice({
					filters: [{services: [serviceUuid]}],
				});

				console.log('Connecting to GATT Server...');
				const server = await device.gatt.connect();

				console.log('Getting Service...');
				const service = await server.getPrimaryService(serviceUuid);

				console.log('Getting Characteristics...');
				characteristics = await service.getCharacteristics();

				let c = characteristics[0];
				console.log(c.uuid);

				console.log("Current temperature: ", dataViewToValues(await c.readValue()));

				await c.startNotifications();
				c.addEventListener('characteristicvaluechanged',(e) => {
					console.log("changed", dataViewToValues(e.target.value));
				});

			} catch(error) {
				console.log('Argh! ' + error);
			}
		}
	</script>
</head>
<body>
	<button onclick="demo()">Launch</button>
</body>
</html>
